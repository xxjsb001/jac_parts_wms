
// 1. 获取库位定位分类特性
$库位定位分类特性集 = 多值查表("R101_基础数据_库位定位分类特性表")

//打印("----库位定位分类特性集" + $库位定位分类特性集)

如果($库位定位分类特性集 == 空) {
	异常("补货失败, 原因: 'R101_基础数据_库位定位分类特性表' 没有维护任何数据")
}

// 2. 获取补货区列表
补货区列表 = 创建列表()
每个($库位定位分类特性  : $库位定位分类特性集) {
	如果($库位定位分类特性.是否支持补货 == "是") {
		加入列表(补货区列表, $库位定位分类特性)
	}
}

//打印("----补货区列表" + 补货区列表)

$未完成补货集 = 数据查询("R101_未完成补货单数据源", "仓库序号",仓库序号)
$未完成补货集为空 = "是"
如果($未完成补货集 != 空 && 列表大小($未完成补货集.补货明细) > 0) {
	$未完成补货集为空 = "否"
}

// 3. 创建补货计划明细
返回列表 = 创建列表()

每个($补货区对象 : 补货区列表) {
	补货区拼接条件字符串 = ""
	库位定位分类列表 = 多值查表("R101_基础数据_库位定位分类表", $补货区对象.库位定位分类)

	补货区拼接条件字符串 = 补货区拼接条件(库位定位分类列表 , 补货区拼接条件字符串).拼接条件返回值
	//打印("----补货区拼接条件字符串:" + 补货区拼接条件字符串)
	
	$安全库存集 = 多值查表("R101_补货_库位分类安全库存表", $补货区对象.库位定位分类)
	如果($安全库存集 == 空 || 列表大小($安全库存集) <= 0) {
		异常("补货区: " + $补货区对象.库位定位分类 + ", 安全库存未设置!")
	}
	
	$待补货库存集为空标识 = "否"
	$待补货库存集 = 数据查询("R101_待补货库存数据源", "仓库序号",仓库序号, "补货区拼接条件",补货区拼接条件字符串)
	
	//打印("----待补货库存集" + $待补货库存集)
	//打印("----安全库存集" + $安全库存集)
	
	如果($待补货库存集 == 空 || 列表大小($待补货库存集) <= 0) {
		$待补货库存集为空标识 = "是"
		
		每个($安全库存 : $安全库存集) {
			
			$包装单位 = 数据查询("R101_货品包装数据源", "货品代码", $安全库存.货品代码, "包装级别", $安全库存.单次补货量)
		
			$待补货明细  = 创建对象()
			$待补货明细.货品代码 = $安全库存.货品代码
			$待补货明细.补货区 = $补货区对象.库位定位分类
			$待补货明细.拣货区 = $安全库存.拣货区
			
			//打印("--1--补货上限:" + $安全库存.补货上限)
			//打印("--1--单次补货量:" + $安全库存.单次补货量)
			
			如果($安全库存.单次补货量 == "托") {
				$待补货明细.计划补货数量 = $安全库存.补货上限			
			}
			如果($安全库存.单次补货量 != "托") {
				$待补货明细.计划补货数量 = 整除($安全库存.补货上限, $包装单位.包装件装量) * $包装单位.包装件装量
			}
			
			如果($未完成补货集为空 == "否") {
				每个($未完成补货明细  : $未完成补货集.补货明细) {
					
					//打印("--1--计划中补货明细.货品代码:" + $未完成补货明细.货品代码)
					//打印("--1--待补货明细.货品代码:" + $待补货明细.货品代码)
					//打印("--1--计划中补货明细.补货区:" + $未完成补货明细.补货区)
					//打印("--1--待补货明细.补货区:" + $待补货明细.补货区)
					
					$货品代码字符串1 =  $未完成补货明细.货品代码 + ""
					$货品代码字符串2 =  $待补货明细.货品代码 + ""
					
					如果($货品代码字符串1 == $货品代码字符串2 && $未完成补货明细.补货区 == $待补货明细.补货区) {
						$待补货明细.计划补货数量 = $待补货明细.计划补货数量 - $未完成补货明细.待补货数量BU
						
						打印("--1--待补货明细.计划补货数量:" + $待补货明细.计划补货数量)
					}
				}
			}
			
			如果($待补货明细.计划补货数量 > 0) {
				加入列表(返回列表, $待补货明细)
			}
		}
	}
	
	如果($待补货库存集为空标识 == "否") {
	
		每个($安全库存 : $安全库存集) {
			$待补货库存存在标识 = "否"
			$包装单位 = 数据查询("R101_货品包装数据源", "货品代码", $安全库存.货品代码, "包装级别", $安全库存.单次补货量)
			
			每个($待补货库存 : $待补货库存集.库存) {
				//打印("----安全库存.货品代码:" + $安全库存.货品代码)
				//打印("----待补货库存.货品代码:" + $待补货库存.货品代码)
				
				
				$货品代码字符串 = $安全库存.货品代码 + ""
				如果($货品代码字符串 == $待补货库存.货品代码) {
					
					//打印("----安全库存.补货下限:" + $安全库存.补货下限)
					//打印("----待补货库存.库存可用数量:" + $待补货库存.库存可用数量)
				
					$待补货库存存在标识 = "是"
					如果($待补货库存.库存可用数量 <= $安全库存.补货下限) {
						$待补货明细  = 创建对象()
						$待补货明细.货品代码 = $安全库存.货品代码
						$待补货明细.补货区 = $补货区对象.库位定位分类
						$待补货明细.拣货区 = $安全库存.拣货区
						$需求数量 = $安全库存.补货上限 - $待补货库存.库存可用数量
						
						//打印("--2--需求数量:" + $需求数量)
						//打印("--2--库存可用数量:" + $待补货库存.库存可用数量)
						//打印("--2--补货上限:" + $安全库存.补货上限)
						//打印("--2--单次补货量:" + $安全库存.单次补货量)
						
						如果($安全库存.单次补货量 == "托") {
							$待补货明细.计划补货数量 = $需求数量
						}
						如果($安全库存.单次补货量 != "托") {
							
							$单次补货 = 整除($需求数量, $包装单位.包装件装量)
					
							$待补货明细.计划补货数量 = $单次补货 * $包装单位.包装件装量
							
							//打印("--2--待补货明细.计划补货数量:" + $待补货明细.计划补货数量)
							//打印("--2--单次补货:" + $单次补货)
							//打印("--2--需求数量:" + $需求数量)
							//打印("--2--包装单位.包装件装量:" + $包装单位.包装件装量)
						}
						
						如果($未完成补货集为空 == "否") {
							每个($未完成补货明细  : $未完成补货集.补货明细) {
							
								//打印("--2--计划中补货明细.货品代码:" + $未完成补货明细.货品代码)
								//打印("--2--待补货明细.货品代码:" + $待补货明细.货品代码)
								//打印("--2--计划中补货明细.补货区:" + $未完成补货明细.补货区)
								//打印("--2--待补货明细.补货区:" + $待补货明细.补货区)
								
								$货品代码字符串1 =  $未完成补货明细.货品代码 + ""
								$货品代码字符串2 =  $待补货明细.货品代码 + ""
								
								如果($货品代码字符串1 == $货品代码字符串2 && $未完成补货明细.补货区 == $待补货明细.补货区) {
									$待补货明细.计划补货数量 = $待补货明细.计划补货数量 - $未完成补货明细.待补货数量BU
									
									//打印("--2--待补货明细.计划补货数量:" + $待补货明细.计划补货数量)
								}
							}
						}
						
						如果($待补货明细.计划补货数量 > 0) {
							加入列表(返回列表, $待补货明细)
						}
					}			
				}
			}
			如果($待补货库存存在标识 == "否") {
				$待补货明细  = 创建对象()
				$待补货明细.货品代码 = $安全库存.货品代码
				$待补货明细.补货区 = $补货区对象.库位定位分类
				$待补货明细.拣货区 = $安全库存.拣货区
				
				//打印("--3--补货上限:" + $安全库存.补货上限)
				//打印("--3--单次补货量:" + $安全库存.单次补货量)
				
				如果($安全库存.单次补货量 == "托") {
					$待补货明细.计划补货数量 = $安全库存.补货上限
				}
				如果($安全库存.单次补货量 != "托") {
					
					$单次补货 = 整除($安全库存.补货上限, $包装单位.包装件装量)
					
					$待补货明细.计划补货数量 = $单次补货 * $包装单位.包装件装量
					
					//打印("--3--待补货明细.计划补货数量:" + $待补货明细.计划补货数量)
					//打印("--3--单次补货:" + $单次补货)
				}
			
				如果($未完成补货集为空 == "否") {
					每个($未完成补货明细  : $未完成补货集.补货明细) {
					
						//打印("--3--未完成补货明细.货品代码:" + $未完成补货明细.货品代码)
						//打印("--3--待补货明细.货品代码:" + $待补货明细.货品代码)
						//打印("--3--未完成补货明细.补货区:" + $未完成补货明细.补货区)
						//打印("--3--待补货明细.补货区:" + $待补货明细.补货区)
						
						$货品代码字符串1 =  $未完成补货明细.货品代码 + ""
						$货品代码字符串2 =  $待补货明细.货品代码 + ""
						
						如果($货品代码字符串1 == $货品代码字符串2 && $未完成补货明细.补货区 == $待补货明细.补货区) {
							$待补货明细.计划补货数量 = $待补货明细.计划补货数量 - $未完成补货明细.待补货数量BU
							
							//打印("--3--待补货明细.计划补货数量:" + $待补货明细.计划补货数量)
						}
					}
				}
				
				如果($待补货明细.计划补货数量 > 0) {
					加入列表(返回列表, $待补货明细)
				}
			}
		}
	}
}

