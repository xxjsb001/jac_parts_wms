package com.vtradex.wms.server.telnet.shell.pick;

import java.io.IOException;

import net.wimpi.telnetd.net.Connection;

import com.vtradex.kangaroo.shell.BreakException;
import com.vtradex.kangaroo.shell.ContinueException;
import com.vtradex.kangaroo.shell.Thorn4BaseShell;
import com.vtradex.wms.server.telnet.dto.WmsPickContainerDTO;
import com.vtradex.wms.server.telnet.pick.WmsPickRFManager;

public class WmsPickPartShell2 extends Thorn4BaseShell{
	
	private final WmsPickRFManager pickRFManager;
	
	public WmsPickPartShell2(WmsPickRFManager pickRFManager) {
		this.pickRFManager = pickRFManager;
	}

	public static final String PAGE_ID = "wmsPickPartShell2"; 
	@Override
	protected void mainProcess(Connection connection) throws BreakException,
			ContinueException, IOException, Exception {
		Long moveDocId = (Long)this.getParentValue("MOVEDOC_ID");
		String container = (String) this.getParentValue("CONTAINER");
		
		WmsPickContainerDTO dto = (WmsPickContainerDTO) this.getParentContext().get("CURRENT_DTO");
		this.output("拣货库位", dto.getPickLocCode());
		this.output("物料编码", dto.getItemCode());
		this.output("物料名称", dto.getItemName());
		this.output("供应商编码", dto.getSupplier());
		this.output("生产线", dto.getProductionLine());
		this.output("待拣数量", dto.getUnMoveQuantityBU().toString());
		Double pickQuantity = this.getNumberField("拣选数量");
		
		if(pickQuantity >  dto.getUnMoveQuantityBU()){
			this.setStatusMessage("拣选数量不能大于待拣数量");
		}
		dto.setPickQuantity(pickQuantity);
		dto.setUnMoveQuantityBU(dto.getPlanQuantityBU()-dto.getPickQuantity());
		pickRFManager.confimPickByPart(dto);
		dto.setLocationCode(dto.getPickLocCode());
		this.context.put("CURRENT_DTO", dto);
		this.put("MOVEDOC_ID", moveDocId);
		this.put("CONTAINER", container);
		this.forward(WmsPickPartShell.PAGE_ID);
	}

}
