package com.vtradex.wms.server.service.shipping.pojo;

import java.util.Date;
import java.util.List;
import java.util.Map;

import com.vtradex.thorn.server.exception.BusinessException;
import com.vtradex.thorn.server.model.Entity;
import com.vtradex.thorn.server.service.WorkflowManager;
import com.vtradex.thorn.server.service.pojo.DefaultBaseManager;
import com.vtradex.thorn.server.util.LocalizedMessage;
import com.vtradex.wms.server.model.move.WmsMoveDoc;
import com.vtradex.wms.server.model.shipping.WmsBOL;
import com.vtradex.wms.server.model.shipping.WmsMasterBOL;
import com.vtradex.wms.server.model.warehouse.WmsDock;
import com.vtradex.wms.server.model.warehouse.WmsLocation;
import com.vtradex.wms.server.service.sequence.WmsBussinessCodeManager;
import com.vtradex.wms.server.service.shipping.WmsMasterBOLManager;
import com.vtradex.wms.server.web.filter.WmsWarehouseHolder;

@SuppressWarnings("unchecked")
public class DefaultWmsMasterBOLManager extends DefaultBaseManager implements
		WmsMasterBOLManager {
	
	private WmsBussinessCodeManager codeManager;
	private WorkflowManager workflowManager;
	
	public DefaultWmsMasterBOLManager(WmsBussinessCodeManager codeManager ,WorkflowManager workflowManager){
		this.codeManager = codeManager;
		this.workflowManager = workflowManager;
	}
	
	public void storeMasterBOL(WmsBOL bol) {
		bol.setWarehouse(WmsWarehouseHolder.getWmsWarehouse());
		bol.setCode(codeManager.generateCodeByRule(bol.getWarehouse(), 
				bol.getWarehouse().getName(), "装车单", ""));
		workflowManager.doWorkflow(bol, "masterBOLProcess.new");
		commonDao.store(bol);
	}

	public void deleteMasterBOL(WmsMasterBOL masterBOL) {
		String hql = "FROM WmsMoveDoc moveDoc WHERE moveDoc.masterBOL.id=:masterBOLId";
		List<WmsMoveDoc> moveDocs = commonDao.findByQuery(hql, 
			new String[] {"masterBOLId"}, new Object[] {masterBOL.getId()});
		for(WmsMoveDoc moveDoc : moveDocs) {
			moveDoc.setMasterBOL(null);
			if(moveDoc.getCarrier()!= null && moveDoc.getCarrier().equals(masterBOL.getCarrier())) {
				moveDoc.setCarrier(null);
			}
			if(moveDoc.getDriver()!= null && moveDoc.getDriver().equals(masterBOL.getDriver())) {
				moveDoc.setDriver(null);
			}
			if(moveDoc.getVehicleNo()!= null && moveDoc.getVehicleNo().equals(masterBOL.getVehicleNo())) {
				moveDoc.setVehicleNo(null);
			}
			commonDao.store(moveDoc);
		}
		commonDao.delete(masterBOL);
	}

	public void deleteMasterBOLDetail(WmsMoveDoc moveDoc) {
		WmsMasterBOL masterBOL = moveDoc.getMasterBOL();
		
//		Double scatteredQuantity = masterBOL.getScatteredQuantity();
//		Double packageQuantity = masterBOL.getPackageQuantity();
//		Double volume = masterBOL.getVolume();
//		Double weight = masterBOL.getWeight();
//		
//		scatteredQuantity = scatteredQuantity - bol.getScatteredQuantity();
//		packageQuantity = packageQuantity - bol.getBoxQuantity();
//		volume = volume - bol.getVolume();
//		weight = weight - bol.getWeight();
		moveDoc.setCarrier(null);
		moveDoc.setDriver(null);
		moveDoc.setVehicleNo(null);
		moveDoc.setMasterBOL(null);
//		
//		masterBOL.setScatteredQuantity(scatteredQuantity);
//		masterBOL.setPackageQuantity(packageQuantity);
//		masterBOL.setVolume(volume);
//		masterBOL.setWeight(weight);
		commonDao.store(masterBOL);
	}

	public void joinMasterBOLDetail(Long masterBOLId,WmsMoveDoc moveDoc) {
		WmsMasterBOL masterBOL = commonDao.load(WmsMasterBOL.class, masterBOLId);
//
//		Double scatteredQuantity = 0D;
//		Double packageQuantity = 0D;
//		Double volume = 0D;
//		Double weight = 0D;
//		packageQuantity += bol.getBoxQuantity();
//		scatteredQuantity += bol.getScatteredQuantity();
//		volume += bol.getVolume();
//		weight += bol.getWeight();
		moveDoc.setCarrier(masterBOL.getCarrier());
		moveDoc.setDriver(masterBOL.getDriver());
		moveDoc.setVehicleNo(masterBOL.getVehicleNo());
		moveDoc.setLineNo(getMaxLineNoByMasterBOL(masterBOL));
		moveDoc.setMasterBOL(masterBOL);
//
//		masterBOL.setScatteredQuantity(scatteredQuantity);
//		masterBOL.setPackageQuantity(packageQuantity);
//		masterBOL.setVolume(volume);
//		masterBOL.setWeight(weight);
		commonDao.store(masterBOL);
	}

	public void reservationDock(WmsMasterBOL masterBOL) {
		String hql = "from WmsMoveDoc doc where doc.masterBOL.id = :masterId";
		List<WmsMoveDoc> lists = this.commonDao.findByQuery(hql, new String[]{"masterId"}, new Object[]{masterBOL.getId()});
		if(lists.size()>0){
			for(WmsMoveDoc moveDoc:lists){
				//发货预约
			}
		}
	}
	
	public Integer getMaxLineNoByMasterBOL(WmsMasterBOL masterBOL ) {				
		Integer lineNo = (Integer) commonDao.findByQueryUniqueResult("SELECT MAX(moveDoc.lineNo) FROM WmsMoveDoc moveDoc WHERE moveDoc.masterBOL.id = :masterBOLId", 		
				new String[] {"masterBOLId"}, new Object[] {masterBOL.getId()});
		if (lineNo == null || lineNo.intValue() == 0) {		
			lineNo = 10;	
		} else {		
			lineNo += 10;	
		}	
		return lineNo;
	}

	public void adjustMasterBOLDetail(WmsMoveDoc bol, List<String> inputValue) {
		Integer lineNo;
		try {
			lineNo = Integer.valueOf(inputValue.get(0));
		} catch (NumberFormatException nfe) {
			throw new BusinessException("行号只能为数值类型！");
		}
		bol.setLineNo(lineNo);
	}
	
	public Boolean beRequirePopupPage(Map map) {
		List<Long> idsList = (List<Long>) map.get("ids");
		Long count = (Long)commonDao.findByQueryUniqueResult("SELECT count ( DISTINCT moveDoc.pickTicket.code) FROM WmsMoveDoc moveDoc WHERE moveDoc.id in (:idsList)", 
				new String[] {"idsList"}, new Object[] {idsList});
		if(count > 1) {
			throw new BusinessException("请选择同一发货单下的BOL");
//			LocalizedMessage.addMessage("请选择同一发货单下的BOL");
//			return false;
		}
		return true;
	}
}