package com.vtradex.wms.server.telnet.shell.pick;

import java.io.IOException;

import org.apache.commons.lang.StringUtils;

import net.wimpi.telnetd.net.Connection;

import com.vtradex.kangaroo.shell.BreakException;
import com.vtradex.kangaroo.shell.ContinueException;
import com.vtradex.kangaroo.shell.ShellFactory;
import com.vtradex.kangaroo.shell.Thorn4BaseShell;
import com.vtradex.wms.server.telnet.dto.WmsPickContainerDTO;
import com.vtradex.wms.server.telnet.pick.WmsPickRFManager;
import com.vtradex.wms.server.web.filter.WmsWorkerHolder;

public class WmsPickContainerCodeShell extends Thorn4BaseShell{
	
	public static final String PAGE_ID = "wmsPickContainerCodeShell";
	
	private final WmsPickRFManager pickRFManager;
	
	public WmsPickContainerCodeShell(WmsPickRFManager pickRFManager) {
		this.pickRFManager = pickRFManager;
	}
	@Override
	protected void mainProcess(Connection connection) throws BreakException,
			ContinueException, IOException, Exception {
		
		WmsPickContainerDTO dto = (WmsPickContainerDTO) this.getParentContext().get("CURRENT_DTO");
		if(dto == null){
			dto = pickRFManager.findPickContainer(WmsWorkerHolder.getWmsWorker());
		}
		if(dto == null){
			this.forward(ShellFactory.getMainShell(),WmsWorkerHolder.getWmsWorker().getName()+"没有器具需要拣货");
		}
		this.output("器具型号", dto.getType());
		if(dto.getContainer() == null || "-".equals(dto.getContainer())){
			String container = this.getTextField("器具编码");
			if(StringUtils.isEmpty(container)){
				this.setStatusMessage("器具编码不能为空");
			}
			String mes = pickRFManager.checkContainerByBoxType(container, dto.getType());
			if(!"".equals(mes)){
				this.remove("器具编码");
				this.setStatusMessage(mes);
			}
			dto.setContainer(container);
		}
		this.context.put("CURRENT_DTO", dto);
		this.forward(WmsPickContainerShell.PAGE_ID);
	}

}
