
出锁库位集 = 多值查表("R101_基础数据_库位出入锁表", "出锁")
出锁拼接条件 = ""
出锁拼接条件 = 出入锁拼接条件(出锁库位集, 出锁拼接条件).出入锁拼接条件返回值

库位定位分类列表 = 多值查表("R101_基础数据_库位定位分类表", 拣货区)
拣货区拼接条件 = ""
拣货区拼接条件 = 拣货区拼接条件(库位定位分类列表 , 拣货区拼接条件).拣货区拼接条件返回值

$未拣选数量 = 待拣选数量

$拣货区托盘库存结果集 = 数据查询("R101_补货_托盘拣货分配数据源", "仓库序号", 仓库序号, "货品序号", 货品序号, "出锁拼接条件",出锁拼接条件,  "拣货区拼接条件", 拣货区拼接条件)

$自增标识 = 0

// 先拿托盘库存 拿不超过待拣选数量最小库存 确保不拆托
如果($拣货区托盘库存结果集 != 空 && 列表大小($拣货区托盘库存结果集) > 0) {
	如果(列表大小($拣货区托盘库存结果集.库存) > 0) {
		列表对象排序($拣货区托盘库存结果集.库存, "库存数量", "降序")
		
		每个($库存 : $拣货区托盘库存结果集.库存) {
			如果($未拣选数量 > 0 && $库存.库存数量 > 0 && $未拣选数量 >= $库存.库存数量) {
				
				$自增标识 = $自增标识 + 1
				$拣货分配结果 = 创建对象()
        		$拣货分配结果.自增标识 = $自增标识
	            $拣货分配结果.货主 = $库存.货主
	            $拣货分配结果.批次序号 = $库存.批次序号
	            $拣货分配结果.货品序号 = $库存.货品序号
	            $拣货分配结果.货品代码 = $库存.货品代码
	            $拣货分配结果.货品基本单位精度 = $库存.货品基本单位精度
	            $拣货分配结果.库存序号 = $库存.库存序号
	            $拣货分配结果.库位序号 = $库存.库位序号
	            $拣货分配结果.包装序号 = $库存.包装序号
	            $拣货分配结果.包装单位 = $库存.包装单位
	            $拣货分配结果.分配数量 = 0
	            
	            $参与分配标识 = "否"
				如果(托盘单次补货 == "否") {
					$拣货分配结果.分配数量 = $库存.库存数量
					$未拣选数量 = $未拣选数量 - $库存.库存数量
	    			$库存.库存数量 = 0
	    			$参与分配标识 = "是"
				}
				
				如果(托盘单次补货 == "是") {
					每个($库存明细 : $库存.托盘) {
						如果($库存明细.库存明细数量 <= $库存.库存数量 && $拣货分配结果.分配数量 < $未拣选数量) {
							
							$托盘货品集 = 数据查询("R101_托盘货品数据源", "托盘号", $库存明细.托盘号)
						
							如果($托盘货品集 != 空 &&  列表大小($托盘货品集.库存明细) == 1) {
								$拣货分配结果.分配数量 = $拣货分配结果.分配数量 + $库存明细.库存明细数量
								$未拣选数量 = $未拣选数量 - $库存明细.库存明细数量
								$库存.库存数量 = $库存.库存数量 - $库存明细.库存明细数量
								$参与分配标识 = "是"
							}
						}
					}
				}
				
				如果($参与分配标识 == "是") {
					加入列表(拣货分配返回列表, $拣货分配结果)
				}
			}
		}
	}
}

如果($未拣选数量 > 0) {
	
	$拣货区非托盘库存结果集 = 数据查询("R101_补货_非托盘拣货分配数据源", "仓库序号", 仓库序号, "货品序号", 货品序号, "出锁拼接条件",出锁拼接条件,  "拣货区拼接条件", 拣货区拼接条件)
	
	//打印("----拣货区非托盘库存结果集:" + $拣货区非托盘库存结果集)
	
	如果($拣货区非托盘库存结果集 != 空 && 列表大小($拣货区非托盘库存结果集) > 0) {
		如果(列表大小($拣货区非托盘库存结果集.库存) > 0) {
			列表对象排序($拣货区非托盘库存结果集.库存, "存货日期", "升序", "库存数量", "降序")
			
			每个($库存 : $拣货区非托盘库存结果集.库存) {
				如果($未拣选数量 > 0 && $库存.库存数量 > 0) {
					$自增标识 = $自增标识 + 1
			
					$拣货分配结果 = 创建对象()
	        		$拣货分配结果.自增标识 = $自增标识
		            $拣货分配结果.货主 = $库存.货主
		            $拣货分配结果.批次序号 = $库存.批次序号
		            $拣货分配结果.货品序号 = $库存.货品序号
		            $拣货分配结果.货品代码 = $库存.货品代码
		            $拣货分配结果.货品基本单位精度 = $库存.货品基本单位精度
		            $拣货分配结果.库存序号 = $库存.库存序号
		            $拣货分配结果.库位序号 = $库存.库位序号
		            $拣货分配结果.包装序号 = $库存.包装序号
		            $拣货分配结果.包装单位 = $库存.包装单位
		            $拣货分配结果.分配数量 = 0
		            
					如果($未拣选数量 > $库存.库存数量) 
		    		{
		    			$拣货分配结果.分配数量 = $库存.库存数量
		    			$未拣选数量 = $未拣选数量 - $库存.库存数量
		    			$库存.库存数量 = 0
		    		}
					如果($未拣选数量 <= $库存.库存数量) 
					{
		    			$拣货分配结果.分配数量 = $未拣选数量
		    			$库存.库存数量 = $库存.库存数量 - $未拣选数量
		    			$未拣选数量 = 0
					}
		        	加入列表(拣货分配返回列表, $拣货分配结果)
				}
			}
		}
	}
}

// 必须拆托时 从最少数量的托盘上拿
如果($拣货区托盘库存结果集 != 空 && 列表大小($拣货区托盘库存结果集) > 0 && $未拣选数量 > 0) {
	如果(列表大小($拣货区托盘库存结果集.库存) != 0) {
		列表对象排序($拣货区托盘库存结果集.库存, "库存数量", "降序")
		
		每个($库存 : $拣货区托盘库存结果集.库存) {
			如果($未拣选数量 > 0 && $库存.库存数量 > 0) {
			
				
				$自增标识 = $自增标识 + 1
			
				$拣货分配结果 = 创建对象()
        		$拣货分配结果.自增标识 = $自增标识
	            $拣货分配结果.货主 = $库存.货主
	            $拣货分配结果.批次序号 = $库存.批次序号
	            $拣货分配结果.货品序号 = $库存.货品序号
	            $拣货分配结果.货品代码 = $库存.货品代码
	            $拣货分配结果.货品基本单位精度 = $库存.货品基本单位精度
	            $拣货分配结果.库存序号 = $库存.库存序号
	            $拣货分配结果.库位序号 = $库存.库位序号
	            $拣货分配结果.包装序号 = $库存.包装序号
	            $拣货分配结果.包装单位 = $库存.包装单位
	            $拣货分配结果.分配数量 = 0
	            
	            $参与分配标识 = "否"
				如果(托盘单次补货 == "否") {
					如果($未拣选数量 < $库存.库存数量) {
		    			$拣货分配结果.分配数量 = $未拣选数量
		    			$库存.库存数量 = $库存.库存数量 - $未拣选数量
		    			$未拣选数量 = 0
		    		}
	    			$参与分配标识 = "是"
				}
				
				如果(托盘单次补货 == "是") {
					如果($未拣选数量 < $库存.库存数量) {
						每个($库存明细 : $库存.托盘) {
							如果($库存明细.库存明细数量 <= $库存.库存数量 && $拣货分配结果.分配数量 < $未拣选数量) {
								$托盘货品集 = 数据查询("R101_托盘货品数据源", "托盘号", $库存明细.托盘号)
								如果($托盘货品集 != 空 &&  列表大小($托盘货品集.库存明细) == 1) {
									$拣货分配结果.分配数量 = $拣货分配结果.分配数量 + $库存明细.库存明细数量
									$未拣选数量 = $未拣选数量 - $库存明细.库存明细数量
									$库存.库存数量 = $库存.库存数量 - $库存明细.库存明细数量
									$参与分配标识 = "是"
								}
							}
						}
					}
				}
				
				如果($参与分配标识 == "是") {
					加入列表(拣货分配返回列表, $拣货分配结果)
				}
			}
		}
	}
}

